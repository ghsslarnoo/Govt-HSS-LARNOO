<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | HSS Larnoo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<style>
    :root {
    --bg-color: #e0e5ec;
    --primary-text: #5c677d;
    --primary-accent: #007bff;
    --success: #28a745;
    --danger: #dc3545;
    --shadow-light: #ffffff;
    --shadow-dark: #a3b1c6;
    --neumorphic-shadow: 8px 8px 15px var(--shadow-dark), -8px -8px 15px var(--shadow-light);
    --neumorphic-shadow-inset: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
}

body {
    font-family: 'Montserrat', sans-serif;
    background-color: var(--bg-color);
    color: var(--primary-text);
    margin: 0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.admin-wrapper { display: flex; min-height: 100vh; position: relative; }

/* --- Sidebar --- */
.sidebar {
    width: 260px;
    background-color: var(--bg-color);
    padding: 20px;
    flex-shrink: 0;
    box-shadow: var(--neumorphic-shadow);
    display: flex;
    flex-direction: column;
    position: fixed;
    left: 0;
    top: 0;
    height: 100%;
    z-index: 1000;
    transform: translateX(0);
    transition: transform 0.3s ease-in-out;
}
.sidebar .logo { text-align: center; margin-bottom: 40px; }
.sidebar .logo img { max-width: 80px; }
.sidebar .logo h3 { font-size: 1rem; color: var(--primary-accent); margin-top: 10px; }
.sidebar-nav { flex-grow: 1; }
.sidebar-nav a {
    display: flex; align-items: center; padding: 15px;
    color: var(--primary-text); text-decoration: none; border-radius: 10px;
    margin-bottom: 10px; font-weight: 600; transition: all 0.2s ease-in-out;
}
.sidebar-nav a:hover { color: var(--primary-accent); background: var(--bg-color); box-shadow: var(--neumorphic-shadow-inset); }
.sidebar-nav a.active { color: var(--primary-accent); box-shadow: var(--neumorphic-shadow-inset); }
.sidebar-nav a i { width: 20px; margin-right: 15px; text-align: center; }

/* --- Main Content --- */
.main-content {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    margin-left: 260px;
    transition: margin-left 0.3s ease-in-out;
}
@media (min-width: 992px) {
    .main-content { padding: 40px; }
}

.main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.main-header h1 { font-size: 1.8rem; color: #333; margin: 0; }
@media (min-width: 768px) {
    .main-header h1 { font-size: 2.5rem; }
}

.header-controls { display: flex; align-items: center; gap: 20px; }
.menu-toggle {
    display: none;
    font-size: 1.5rem;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--primary-text);
}
.logout-btn {
    padding: 12px 25px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
    background: var(--bg-color); color: var(--primary-text); box-shadow: var(--neumorphic-shadow);
    transition: all 0.2s ease-in-out;
}
.logout-btn:hover { box-shadow: var(--neumorphic-shadow-inset); color: var(--danger); }

/* --- Mobile Responsiveness --- */
@media (max-width: 992px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .menu-toggle { display: block; }
}

.content-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4); z-index: 999;
    opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}
.content-overlay.active { opacity: 1; visibility: visible; }

/* Reusable Neumorphic Components */
.neumorphic-card { background: var(--bg-color); padding: 30px; border-radius: 20px; box-shadow: var(--neumorphic-shadow); }
.neumorphic-input, .neumorphic-select, .neumorphic-textarea {
    width: 100%; border: none; outline: none; padding: 15px 20px; border-radius: 10px;
    background: var(--bg-color); box-shadow: var(--neumorphic-shadow-inset);
    color: var(--primary-text); font-size: 1rem;
}
.neumorphic-btn {
    border: none; padding: 15px 30px; border-radius: 10px; background: var(--bg-color);
    color: var(--primary-text); box-shadow: var(--neumorphic-shadow); font-weight: 600;
    cursor: pointer; transition: all 0.2s ease-in-out;
}
.neumorphic-btn:hover { box-shadow: var(--neumorphic-shadow-inset); }
.neumorphic-btn.primary { color: var(--primary-accent); }
.neumorphic-btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: var(--neumorphic-shadow-inset); }

/* Dashboard Cards */
.dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 30px; }
.dashboard-card { text-align: center; }
.dashboard-card i { font-size: 3rem; color: var(--primary-accent); margin-bottom: 15px; }
.dashboard-card .count { font-size: 2.5rem; font-weight: 700; color: #333; }
#subscribers-card { cursor: pointer; }


/* Table Styling */
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
th, td { padding: 20px; text-align: left; }
th { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
tbody tr { background: var(--bg-color); box-shadow: var(--neumorphic-shadow); border-radius: 10px; }
td:first-child { border-radius: 10px 0 0 10px; }
td:last-child { border-radius: 0 10px 10px 0; }

/* Login Page */
.login-wrapper { display: flex; justify-content: center; align-items: center; height: 100vh; padding: 20px;}
.login-box { width: 100%; max-width: 400px; text-align: center; }
.login-box img { max-width: 100px; margin-bottom: 20px; }

/* Styling for Management Sections and Modals */

.section-card {
    margin-bottom: 40px;
}

.section-card h2 {
    margin-top: 0;
    margin-bottom: 30px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    color: var(--primary-accent);
}

.section-card h2 i {
    margin-right: 10px;
}

.manage-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.manage-list li {
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 10px;
    background: var(--bg-color);
    box-shadow: var(--neumorphic-shadow);
    transition: all 0.2s ease-in-out;
}

.manage-list li:hover {
    transform: translateY(-2px);
    box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
}

.manage-list img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 50%;
    margin-right: 20px;
    flex-shrink: 0;
}

.manage-list .item-details {
    flex-grow: 1;
}

.manage-list .item-details strong {
    display: block;
    font-size: 1.1rem;
    color: #333;
}

.manage-list .item-details span {
    font-size: 0.9rem;
    color: var(--primary-text);
}

.manage-list .item-actions {
    display: flex;
    gap: 10px;
}

.item-actions .neumorphic-btn {
    padding: 10px 15px;
}

.item-actions .neumorphic-btn.danger {
    color: var(--danger);
}
.item-actions .neumorphic-btn.danger:hover {
    color: #fff;
    background: var(--danger);
}


/* --- Modal Styles --- */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    margin: 5% auto;
    padding: 40px;
    width: 90%;
    max-width: 700px;
    position: relative;
}

.close-btn {
    color: #aaa;
    position: absolute;
    top: 15px;
    right: 25px;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
}

.close-btn:hover,
.close-btn:focus {
    color: var(--danger);
    text-decoration: none;
}

.image-preview {
    margin-top: 10px;
    max-width: 150px;
    max-height: 150px;
    border-radius: 10px;
    box-shadow: var(--neumorphic-shadow-inset);
    padding: 5px;
    display: block;
}

.feedback-message {
    margin-top: 15px;
    font-weight: 600;
    min-height: 24px;
}
.feedback-message.success { color: var(--success); }
.feedback-message.error { color: var(--danger); }
</style>
<body>
    <div id="login-view" class="login-wrapper">
        <div class="neumorphic-card login-box">
            <img src="../img/logo3.png" alt="Logo">
            <h2>Admin Panel</h2>
            <p id="login-error" style="color: var(--danger); height: 20px;"></p>
            <form id="login-form">
                <div style="margin-bottom: 20px;">
                    <input type="password" id="adminPassword" class="neumorphic-input" placeholder="Enter Password" required>
                </div>
                <button type="submit" class="neumorphic-btn primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <div id="dashboard-view" class="admin-wrapper" style="display: none;">
        <div id="content-overlay" class="content-overlay"></div>
        <aside class="sidebar">
            <div class="logo">
                <img src="../img/logo3.png" alt="HSS Larnoo Logo"><h3>HSS Larnoo</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="upload-blog.html"><i class="fas fa-pencil-alt"></i> Post Blog</a>
                <a href="upload-event.html"><i class="fas fa-calendar-alt"></i> Post Event</a>
                <a href="upload-program.html"><i class="fas fa-book"></i> Post Program</a>
                <a href="contact-messages.html"><i class="fas fa-envelope-open-text"></i> Messages</a>
                <a href="upload-notice.html"><i class="fas fa-bullhorn"></i> Post Notice</a>
                <a href="upload-gallery.html"><i class="fas fa-images"></i> Upload to Gallery</a>
                <hr>
                <h2 style="color: rgba(2, 165, 177, 0.856);">Email Subscription</h2>

                <a href="canvas.html"><i class="fas fa-pen-to-square"></i> Create Email</a>
                <a href="event-sender.html"><i class="fas fa-paper-plane"></i> Send Email</a>

            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button id="menu-toggle" class="menu-toggle"><i class="fas fa-bars"></i></button>
                <h1>Dashboard</h1>
                <div class="header-controls">
                    <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <div class="dashboard-cards">
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-pencil-alt"></i>
                    <h2 class="count" id="blogs-count">...</h2><p>Blog Posts</p>
                </div>
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-calendar-alt"></i>
                    <h2 class="count" id="events-count">...</h2><p>Events</p>
                </div>
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-book"></i>
                    <h2 class="count" id="programs-count">...</h2><p>Programs</p>
                </div>
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-envelope-open-text"></i>
                    <h2 class="count" id="messages-count">...</h2><p>Contact Messages</p>
                </div>
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-images"></i>
                    <h2 class="count" id="gallery-count">...</h2><p>Gallery Images</p>
                </div>
                <div class="neumorphic-card dashboard-card">
                    <i class="fas fa-bullhorn"></i>
                    <h2 class="count" id="notices-count">...</h2><p>Active Notices</p>
                </div>
                <div id="subscribers-card" class="neumorphic-card dashboard-card">
                    <i class="fas fa-users"></i>
                    <h2 class="count" id="subscribers-count">...</h2><p>Newsletter Subscribers</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Subscribers Modal -->
    <div id="subscribers-modal" class="modal">
        <div class="modal-content neumorphic-card">
            <span id="close-subscribers-modal" class="close-btn">&times;</span>
            <div class="section-card">
                <h2><i class="fas fa-users"></i> Manage Subscribers</h2>

                <!-- Add Subscriber Form -->
                <form id="add-subscriber-form" style="display: flex; gap: 15px; margin-bottom: 30px;">
                    <input type="email" id="subscriber-email" class="neumorphic-input" placeholder="New subscriber email" required style="flex-grow: 1;">
                    <button type="submit" class="neumorphic-btn primary">Add</button>
                </form>
                <div id="subscriber-feedback" class="feedback-message"></div>

                <!-- Subscribers List -->
                <ul id="subscribers-list" class="manage-list">
                    <!-- Subscriber items will be dynamically inserted here -->
                </ul>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBAUBnBW_wcY3evdk4ilKVyvufkkYo6rIU", 
            authDomain: "hss-larnoo-teachers.firebaseapp.com", 
            projectId: "hss-larnoo-teachers", 
            storageBucket: "hss-larnoo-teachers.appspot.com", 
            messagingSenderId: "143363278401", 
            appId: "1:143363278401:web:49d7fffbdf31ce073e68c0", 
            measurementId: "G-GHQLMME6PJ" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ADMIN_PASSWORD = "hsslarnoo@admin25"; // Updated admin password

        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('adminPassword');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');

        // Subscribers Modal elements
        const subscribersCard = document.getElementById('subscribers-card');
        const subscribersModal = document.getElementById('subscribers-modal');
        const closeSubscribersModalBtn = document.getElementById('close-subscribers-modal');
        const subscribersList = document.getElementById('subscribers-list');
        const addSubscriberForm = document.getElementById('add-subscriber-form');
        const subscriberEmailInput = document.getElementById('subscriber-email');
        const subscriberFeedback = document.getElementById('subscriber-feedback');


        function showDashboard() {
            loginView.style.display = 'none';
            dashboardView.style.display = 'flex';
            fetchDashboardStats();
            // Sidebar toggle logic
            const sidebar = document.querySelector('#dashboard-view .sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('content-overlay');
            if (sidebar && menuToggle && overlay) {
                menuToggle.addEventListener('click', () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); });
                overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });
            }
        }

        function showLogin() { loginView.style.display = 'flex'; dashboardView.style.display = 'none'; }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === ADMIN_PASSWORD) { sessionStorage.setItem('isAdminLoggedIn', 'true'); showDashboard(); }
            else { loginError.textContent = 'Incorrect password.'; }
        });

        logoutBtn.addEventListener('click', () => { sessionStorage.removeItem('isAdminLoggedIn'); showLogin(); });

        /**
         * PERFORMANCE FIX: Fetches all collection counts in parallel for faster loading.
         */
        async function fetchDashboardStats() {
            const collections = ['blogs', 'events', 'programs', 'contact_messages', 'galleryImages', 'notices', 'newsletter_subscribers'];
            const promises = collections.map(name => getDocs(collection(db, name)).then(snapshot => snapshot.size).catch(e => {
                console.error(`Error fetching ${name}:`, e);
                return 'N/A';
            }));

            const [blogs, events, programs, messages, gallery, notices, subscribers] = await Promise.all(promises);

            document.getElementById('blogs-count').textContent = blogs;
            document.getElementById('events-count').textContent = events;
            document.getElementById('programs-count').textContent = programs;
            document.getElementById('messages-count').textContent = messages;
            document.getElementById('gallery-count').textContent = gallery;
            document.getElementById('notices-count').textContent = notices;
            document.getElementById('subscribers-count').textContent = subscribers;
        }

        // --- SUBSCRIBERS MODAL LOGIC ---

        // Function to render the list of subscribers
        async function renderSubscribers() {
            try {
                const querySnapshot = await getDocs(collection(db, "newsletter_subscribers"));
                subscribersList.innerHTML = ''; // Clear existing list
                if (querySnapshot.empty) {
                    subscribersList.innerHTML = '<p>No subscribers yet.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const subscriber = doc.data();
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="item-details">
                            <strong>${subscriber.email}</strong>
                        </div>
                        <div class="item-actions">
                            <button class="neumorphic-btn danger remove-subscriber-btn" data-id="${doc.id}">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    `;
                    subscribersList.appendChild(li);
                });

                // Add event listeners to the new remove buttons
                document.querySelectorAll('.remove-subscriber-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.currentTarget.dataset.id;
                        if (confirm('Are you sure you want to remove this subscriber?')) {
                            await deleteSubscriber(docId);
                        }
                    });
                });

            } catch (error) {
                console.error("Error fetching subscribers:", error);
                subscribersList.innerHTML = '<p style="color: var(--danger);">Error loading subscribers.</p>';
            }
        }

        // Function to delete a subscriber
        async function deleteSubscriber(docId) {
            try {
                await deleteDoc(doc(db, "newsletter_subscribers", docId));
                subscriberFeedback.textContent = 'Subscriber removed successfully.';
                subscriberFeedback.className = 'feedback-message success';
                renderSubscribers(); // Refresh the list
                fetchDashboardStats(); // Update dashboard count
            } catch (error) {
                console.error("Error removing subscriber: ", error);
                subscriberFeedback.textContent = 'Failed to remove subscriber.';
                subscriberFeedback.className = 'feedback-message error';
            }
        }

        // Handle Add Subscriber form submission
        addSubscriberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = subscriberEmailInput.value.trim();
            if (!email) return;

            try {
                await addDoc(collection(db, "newsletter_subscribers"), {
                    email: email,
                    subscribedAt: serverTimestamp()
                });
                subscriberFeedback.textContent = 'Subscriber added successfully.';
                subscriberFeedback.className = 'feedback-message success';
                addSubscriberForm.reset();
                renderSubscribers(); // Refresh the list
                fetchDashboardStats(); // Update dashboard count
            } catch (error) {
                console.error("Error adding subscriber: ", error);
                subscriberFeedback.textContent = 'Failed to add subscriber.';
                subscriberFeedback.className = 'feedback-message error';
            }
        });


        // Show/Hide Modal
        subscribersCard.addEventListener('click', () => {
            subscribersModal.style.display = 'block';
            subscriberFeedback.textContent = ''; // Clear feedback message
            renderSubscribers();
        });

        closeSubscribersModalBtn.addEventListener('click', () => {
            subscribersModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == subscribersModal) {
                subscribersModal.style.display = 'none';
            }
        });


        // Initial Check
        if (sessionStorage.getItem('isAdminLoggedIn') === 'true') { showDashboard(); }
        else { showLogin(); }
    </script>
</body>
</html>