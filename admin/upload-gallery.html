<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload to Gallery | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
    <script type="module" src="js/admin-auth.js"></script>
    <style>
        #image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; box-shadow: var(--neumorphic-shadow); }
        #upload-log { margin-top: 15px; padding: 15px; border-radius: 10px; font-size: 0.85rem; max-height: 150px; overflow-y: auto; background-color: var(--bg-color); box-shadow: var(--neumorphic-shadow-inset); }
    </style>
</head>
<body>
    <div id="content-overlay" class="content-overlay"></div>
    <div class="admin-wrapper">
        <!-- ... rest of your page content ... -->
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="logo">
                <img src="../img/logo3.png" alt="HSS Larnoo Logo"><h3>HSS Larnoo</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a href="upload-blog.html"><i class="fas fa-pencil-alt"></i> Post Blog</a>
                <a href="upload-event.html"><i class="fas fa-calendar-alt"></i> Post Event</a>
                <a href="upload-program.html"><i class="fas fa-book"></i> Post Program</a>
                <a href="contact-messages.html"><i class="fas fa-envelope-open-text"></i> Messages</a>
                <a href="upload-notice.html"><i class="fas fa-bullhorn"></i> Post Notice</a>
                <a href="upload-gallery.html"  class="active"><i class="fas fa-images"></i> Upload to Gallery</a>
                <hr>
                <h2 style="color: rgba(2, 165, 177, 0.856);">Email Subscription</h2>

                <a href="canvas.html"><i class="fas fa-pen-to-square"></i> Create Email</a>
                <a href="event-sender.html"><i class="fas fa-paper-plane"></i> Send Email</a>

            </nav>
        </aside>

        <main class="main-content">
            <!-- NEW, RESPONSIVE HEADER -->
<header class="main-header">
    <button id="menu-toggle" class="menu-toggle"><i class="fas fa-bars"></i></button>
    <h1>Batch Upload To Gallery</h1> <!-- Remember to change the title on each page -->
    <div class="header-controls">
        <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
</header>

            <div class="neumorphic-card">
                 <div id="statusMessage" class="alert d-none" role="alert"></div>
                <form id="galleryForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="imageCategory" class="form-label fw-bold">1. Select Category</label>
                            <select class="neumorphic-select" id="imageCategory" required>
                                <option value="" selected disabled>-- Loading... --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="customCategoryContainer" style="display: none;">
                            <label for="customCategory" class="form-label fw-bold">New Category Name</label>
                            <input type="text" class="neumorphic-input" id="customCategory">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="batchCaption" class="form-label fw-bold">2. Batch Caption (Prefix)</label>
                        <input type="text" class="neumorphic-input" id="batchCaption" placeholder="e.g., Annual Sports Day">
                    </div>
                    <div class="mb-3">
                        <label for="imageFiles" class="form-label fw-bold">3. Select Images</label>
                        <input type="file" class="neumorphic-input" id="imageFiles" accept="image/jpeg, image/png" required multiple>
                    </div>

                    <div id="image-previews"></div>

                    <div id="progress-container" class="mt-4" style="display: none;">
                        <div class="progress" style="height: 20px; border-radius: 10px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="upload-log"></div>
                    </div>

                    <div class="d-grid mt-4">
                        <button id="submitBtn" class="neumorphic-btn primary" type="submit">
                            <i class="fas fa-upload me-2"></i>Upload Selected Files
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

       <!-- Firebase SDK and Custom Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBAUBnBW_wcY3evdk4ilKVyvufkkYo6rIU",
            authDomain: "hss-larnoo-teachers.firebaseapp.com",
            projectId: "hss-larnoo-teachers",
            storageBucket: "hss-larnoo-teachers.appspot.com",
            messagingSenderId: "143363278401",
            appId: "1:143363278401:web:49d7fffbdf31ce073e68c0",
            measurementId: "G-GHQLMME6PJ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Admin Password ---
        const ADMIN_PASSWORD = "hsslarnoo@admin25";

        // --- Default Categories List ---
        const defaultCategories = [
            "Debates & School Events", "Campus Beautification", "Morning Assembly & Prayer", "Environmental Activities", 
            "International Day Against Drug Abuse", "Campus Gardening", "ICT Lab", "Tourism Lab", "Industrial Visits", 
            "Visit to Polytechnique College", "Sports & Athletics", "Picnics & Excursions", "Plantation Drives", 
            "Run For Unity", "Campus Views", "Student Life", "Nurturing Nature", "International Yoga Day"
        ];

        // --- DOM Element References ---
        const dom = {
            galleryForm: document.getElementById('galleryForm'),
            submitBtn: document.getElementById('submitBtn'),
            statusMessage: document.getElementById('statusMessage'),
            imageFilesInput: document.getElementById('imageFiles'),
            previewsContainer: document.getElementById('image-previews'),
            categoryDropdown: document.getElementById('imageCategory'),
            customCategoryContainer: document.getElementById('customCategoryContainer'),
            customCategoryInput: document.getElementById('customCategory'),
            batchCaptionInput: document.getElementById('batchCaption'),
            adminPasswordField: document.getElementById('adminPassword'),
            unlockBtn: document.getElementById('unlockBtn'),
            formFieldset: document.getElementById('form-fieldset'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progressBar'),
            uploadLog: document.getElementById('upload-log'),
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', populateCategories);
        dom.imageFilesInput.addEventListener('change', handleFileSelect);
        dom.categoryDropdown.addEventListener('change', handleCategoryChange);
        dom.galleryForm.addEventListener('submit', handleFormSubmit);
        dom.unlockBtn.addEventListener('click', handleAdminAuth);
        
        // --- Core Functions ---

        /**
         * Unlocks the form when the correct admin password is entered.
         */
        function handleAdminAuth() {
            if (dom.adminPasswordField.value === ADMIN_PASSWORD) {
                dom.formFieldset.disabled = false;
                document.getElementById('admin-auth').style.display = 'none';
                showStatusMessage('Form unlocked. You can now upload.', 'alert-success');
            } else {
                showStatusMessage('Incorrect password.', 'alert-danger');
            }
        }
        
        /**
         * Fetches existing categories from Firestore, merges them with the default list,
         * sorts them, and populates the dropdown menu.
         */
        async function populateCategories() {
             try {
                const fetchedCategories = new Set();
                const querySnapshot = await getDocs(collection(db, "galleryImages"));
                querySnapshot.forEach(doc => {
                    if (doc.data().category) fetchedCategories.add(doc.data().category);
                });

                const allCategories = new Set([...defaultCategories, ...fetchedCategories]);
                const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

                dom.categoryDropdown.innerHTML = '<option value="" selected disabled>-- Choose a section --</option>';
                sortedCategories.forEach(cat => dom.categoryDropdown.add(new Option(cat, cat)));
                dom.categoryDropdown.add(new Option("Other (Create New)", "Other"));

            } catch (error) {
                console.error("Error populating categories:", error);
                dom.categoryDropdown.innerHTML = '<option value="">Error loading categories</option>';
                showStatusMessage('Could not load categories from the database. Check console for errors.', 'alert-danger');
            }
        }

        /**
         * Handles file selection, auto-populates the caption for a single file,
         * and generates image previews for all selected files.
         */
        function handleFileSelect(event) {
            dom.previewsContainer.innerHTML = '';
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Auto-fill caption only if one file is selected
            if (files.length === 1) {
                const file = files[0];
                const fileNameWithoutExt = file.name.split('.').slice(0, -1).join('');
                dom.batchCaptionInput.value = fileNameWithoutExt.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            } else {
                dom.batchCaptionInput.placeholder = `e.g., Annual Sports Day (Prefix for ${files.length} images)`;
            }

            // Generate previews
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    dom.previewsContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Shows or hides the custom category input field based on dropdown selection.
         */
        function handleCategoryChange() {
            const isOther = dom.categoryDropdown.value === 'Other';
            dom.customCategoryContainer.style.display = isOther ? 'block' : 'none';
            dom.customCategoryInput.required = isOther;
        }

        /**
         * Main function to handle the form submission, validation, and upload loop.
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            setLoadingState(true);
            dom.progressContainer.style.display = 'block';
            dom.uploadLog.innerHTML = '';
            
            let category = dom.categoryDropdown.value === 'Other' ? dom.customCategoryInput.value.trim() : dom.categoryDropdown.value;
            const batchCaption = dom.batchCaptionInput.value.trim();
            const files = dom.imageFilesInput.files;

            if (!category || files.length === 0) {
                showStatusMessage('Please select a category and at least one image.', 'alert-danger');
                setLoadingState(false);
                return;
            }

            let uploadedCount = 0, failedCount = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = file.name.split('.').slice(0, -1).join('').replace(/[-_]/g, ' ');
                const finalCaption = batchCaption ? `${batchCaption} - ${fileName}` : fileName;

                try {
                    logMessage(`[${i+1}/${files.length}] Processing: ${file.name}`);
                    const compressedImageBase64 = await resizeAndCompressImage(file);
                    
                    if (compressedImageBase64.length > 1000000) {
                        throw new Error("Compressed image is still too large (>1MB). Please use a smaller image.");
                    }

                    logMessage(`Uploading: ${file.name}...`);
                    await addDoc(collection(db, "galleryImages"), {
                        caption: finalCaption,
                        category,
                        imageBase64: compressedImageBase64,
                        timestamp: serverTimestamp()
                    });
                    uploadedCount++;
                    logMessage(`SUCCESS: ${file.name} uploaded.`, 'text-success');
                } catch (error) {
                    failedCount++;
                    console.error(`Failed to upload ${file.name}:`, error);
                    logMessage(`FAILED: ${file.name} - ${error.message}`, 'text-danger');
                } finally {
                    updateProgressBar(i + 1, files.length);
                }
            }
            
            const finalMessage = `Batch complete. ${uploadedCount} succeeded, ${failedCount} failed.`;
            showStatusMessage(finalMessage, failedCount > 0 ? 'alert-warning' : 'alert-success');
            setLoadingState(false);
            if (failedCount === 0) {
                 setTimeout(() => { window.location.href = 'upload-gallery.html'; }, 2000);
            }
        }
        
        /**
         * Takes an image file, resizes it to a max width/height, and compresses it.
         * @returns {Promise<string>} A promise that resolves with the Base64 data URL of the compressed image.
         */
        function resizeAndCompressImage(file, maxWidth = 1200, quality = 0.8) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth || height > maxWidth) {
                            if (width > height) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            } else {
                                width = Math.round((width * maxWidth) / height);
                                height = maxWidth;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        /**
         * Displays a status message to the user.
         */
        function showStatusMessage(message, type) {
            dom.statusMessage.textContent = message;
            dom.statusMessage.className = `alert ${type}`;
            dom.statusMessage.classList.remove('d-none');
        }

        /**
         * Toggles the loading state of the submit button.
         */
        function setLoadingState(isLoading) {
            dom.submitBtn.disabled = isLoading;
            dom.submitBtn.innerHTML = isLoading 
                ? '<span class="spinner-border spinner-border-sm"></span> Uploading...'
                : '<i class="fas fa-upload me-2"></i>Upload Selected Files';
        }

        /**
         * Updates the progress bar during batch uploads.
         */
        function updateProgressBar(current, total) {
            const percentage = Math.round((current / total) * 100);
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressBar.textContent = `${percentage}%`;
        }

        /**
         * Logs a message to the progress log area.
         */
        function logMessage(message, className = '') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = `mb-1 ${className}`;
            dom.uploadLog.appendChild(p);
            dom.uploadLog.scrollTop = dom.uploadLog.scrollHeight; // Auto-scroll
        }
    </script>
    
    <!-- JS Libraries (Keep these at the bottom) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
</body>
</html>