<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Futuristic Event Sender - HSS Larnoo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-dark: #1a1c23;
            --bg-med: #252830;
            --border-color: #444857;
            --text-primary: #f0f2f5;
            --text-secondary: #a0a8b4;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-primary); display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; gap: 20px; }
        .container { background: var(--bg-med); padding: 40px; border-radius: 12px; border: 1px solid var(--border-color); width: 100%; max-width: 600px; }
        .preview-container { width: 100%; max-width: 700px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1, h2 { color: var(--text-primary); }
        h2 { font-size: 1.2rem; color: var(--text-secondary); }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary); }
        textarea, input[type="text"], input[type="email"] { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 16px; background: var(--bg-dark); color: var(--text-primary); }
        button { display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 15px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 18px; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #status-container { margin-top: 20px; }
        #progress-bar { width: 100%; background-color: var(--border-color); border-radius: 4px; overflow: hidden; height: 10px; margin-top: 10px; display: none; }
        #progress-fill { width: 0%; height: 100%; background-color: #4caf50; transition: width 0.5s ease; }
        #email-preview { width: 100%; height: 80vh; border: 1px solid var(--border-color); border-radius: 8px; background: white; }
        .back-link { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .test-send-section { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        .test-send-section input { margin-bottom: 0; }
        .test-send-section button { width: auto; padding: 12px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Send Newsletter</h1>
            <a href="canvas.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Editor</a>
        </div>
        <h2 id="subscriber-count">Loading subscribers...</h2>
        
        <label for="email-subject">Email Subject:</label>
        <input type="text" id="email-subject" placeholder="e.g., Important Announcement from HSS Larnoo">

        <label for="email-body">Email HTML Body:</label>
        <textarea id="email-body" rows="12" placeholder="Paste your HTML code here, or design it in the builder first."></textarea>

        <hr style="border-color: var(--border-color); margin: 20px 0;">
        
        <h3><i class="fas fa-flask" style="color:#ffc107;"></i> Send a Test</h3>
        <div class="test-send-section">
            <input type="email" id="test-email-address" placeholder="Enter test email address">
            <button id="test-send-btn"><i class="fas fa-paper-plane"></i> Send Test</button>
        </div>

        <hr style="border-color: var(--border-color); margin: 20px 0;">

        <button id="send-btn"><i class="fas fa-rocket"></i> Send to All Subscribers</button>
        <div id="status-container">
            <p id="status-text"></p>
            <div id="progress-bar"><div id="progress-fill"></div></div>
        </div>
    </div>
    
    <div class="preview-container">
        <h1>Live Preview</h1>
        <iframe id="email-preview" title="Email Preview"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAUBnBW_wcY3evdk4ilKVyvufkkYo6rIU",
            authDomain: "hss-larnoo-teachers.firebaseapp.com",
            projectId: "hss-larnoo-teachers",
            storageBucket: "hss-larnoo-teachers.appspot.com",
            messagingSenderId: "143363278401",
            appId: "1:143363278401:web:49d7fffbdf31ce073e68c0"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const EMAILJS_SERVICE_ID = 'service_01cuq2o';
        const EMAILJS_TEMPLATE_ID = 'template_jgdd2wl';
        const EMAILJS_PUBLIC_KEY = '0Q7acQc7s1VPBgO9_';

        const emailBody = document.getElementById('email-body');
        const previewFrame = document.getElementById('email-preview');
        
        function updatePreview() {
            previewFrame.srcdoc = emailBody.value;
        }
        
        emailBody.addEventListener('input', updatePreview);
        
        async function initialize() {
            emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
            
            // Auto-load HTML from builder
            const savedHtml = localStorage.getItem('newsletterHtml');
            if (savedHtml) {
                emailBody.value = savedHtml;
                updatePreview();
                localStorage.removeItem('newsletterHtml'); // Clean up
            }

            try {
                const querySnapshot = await getDocs(collection(db, "newsletter_subscribers"));
                const subscribers = querySnapshot.docs.map(doc => doc.data().email);
                document.getElementById('subscriber-count').textContent = `${subscribers.length} Subscribers Loaded`;
                window.subscribers = subscribers; // Make it globally accessible for send functions
            } catch (error) {
                document.getElementById('subscriber-count').textContent = 'Error loading subscribers.';
                console.error("Firestore Error:", error);
            }
        }

        initialize();

        // Test Send Logic
        document.getElementById('test-send-btn').addEventListener('click', async () => {
             const testEmail = document.getElementById('test-email-address').value;
             if (!testEmail) { alert('Please enter a test email address.'); return; }
             
             const subject = document.getElementById('email-subject').value || "Test Email";
             const html_content = emailBody.value;
             if (!html_content) { alert('Email body is empty.'); return; }

             const btn = document.getElementById('test-send-btn');
             btn.disabled = true;
             btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending...`;
             
             try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { subject, html_content, to_email: testEmail });
                alert(`Test email sent successfully to ${testEmail}!`);
             } catch (error) {
                alert(`Failed to send test email. Error: ${error.text}`);
             } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-paper-plane"></i> Send Test`;
             }
        });


        // Bulk Send Logic
        document.getElementById('send-btn').addEventListener('click', async () => {
            if (!confirm(`Are you sure you want to send this to ${window.subscribers.length} subscribers?`)) return;

            const subject = document.getElementById('email-subject').value;
            const html_content = emailBody.value;
            if (!subject || !html_content) { alert('Subject and Body cannot be empty.'); return; }

            // ... [Your existing bulk send logic with progress bar]
             const sendBtn = document.getElementById('send-btn');
             const statusText = document.getElementById('status-text');
             const progressBar = document.getElementById('progress-bar');
             const progressFill = document.getElementById('progress-fill');

             sendBtn.disabled = true;
             progressBar.style.display = 'block';
             progressFill.style.width = '0%';
             let emailsSent = 0;

            for (const email of window.subscribers) {
                 try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { subject, html_content, to_email: email });
                    emailsSent++;
                    statusText.textContent = `Sending... (${emailsSent} of ${window.subscribers.length})`;
                    progressFill.style.width = `${(emailsSent / window.subscribers.length) * 100}%`;
                 } catch(err) {
                     statusText.textContent = `Failed on email #${emailsSent + 1} (${email}). See console for details.`;
                     console.error(err);
                     sendBtn.disabled = false;
                     return;
                 }
            }
            statusText.textContent = `Success! Newsletter sent to all ${emailsSent} subscribers.`;
            sendBtn.disabled = false;
        });

    </script>
</body>
</html>